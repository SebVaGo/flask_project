{% extends "bootstrap/base.html" %}
{% block title %}Editar Orden{% endblock %}

{% block content %}
<div class="container mt-5">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} mt-2">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <h2>Editar Orden #{{ order.orden_id }}</h2>
  <form id="editOrderForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <!-- Si lo deseas, puedes incluir el usuario en un input hidden para JS:
         <input type="hidden" id="usuario_id" value="{{ order.usuario_id }}"> -->

    <!-- Tabla con los productos que ya están en la orden -->
    <h3>Productos en la Orden</h3>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="orderEditList">
        {% for item in order.productos %}
        <tr data-producto-id="{{ item.producto_id }}">
          <td>{{ item.producto_nombre }}</td>
          <td>
            <input type="number" class="form-control form-control-sm quantity-input" 
                   value="{{ item.cantidad }}" min="1">
          </td>
          <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeProductRow(this)">Eliminar</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Botón para enviar la actualización de la orden -->
    <button type="button" class="btn btn-success" onclick="submitOrderUpdate('{{ order.orden_id }}')">
      Guardar Cambios
    </button>
  </form>

  <!-- Tabla de productos disponibles para agregar -->
  <h3 class="mt-5">Productos Disponibles</h3>
  {% if productos_disponibles %}
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Categoría</th>
        <th>Precio</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody>
      {% for product in productos_disponibles %}
      <tr>
        <td>{{ product.id }}</td>
        <td>{{ product.nombre }}</td>
        <td>{{ product.categoria }}</td>
        <td>S/ {{ "%.2f"|format(product.precio) }}</td>
        <td>
          <button type="button" class="btn btn-primary btn-sm" 
                  onclick="addProductToOrder('{{ product.id }}', '{{ product.nombre }}', '{{ product.precio }}')">
            Agregar
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No hay productos disponibles para agregar.</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
  <script>
    // Jinja inyecta el valor real de order.usuario_id en la variable global
    window.USER_ID = {{ order.usuario_id }};
  </script>
  <script src="{{ url_for('static', filename='js/edit_order.js') }}"></script>
{% endblock %}
