{% extends "bootstrap/base.html" %}

{% block title %}Gesti√≥n de Productos{% endblock %}

{% block head %}
{{ super() }}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Gesti√≥n de Productos</h2>

    <div class="d-flex justify-content-between mb-3">
        <a href="{{ url_for('admin.new_product_form') }}" class="btn btn-success">Crear Producto</a>
        <a href="{{ url_for('order.list_orders') }}" class="btn btn-info">Ver Compras</a>
    </div>

    {% if products %}
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Categor√≠a</th>
                <th>Precio</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td>{{ product.id }}</td>
                <td>{{ product.nombre }}</td>
                <td>{{ product.categoria }}</td>
                <td>S/ {{ "%.2f"|format(product.precio) }}</td>
                <td>
                    <a href="{{ url_for('admin.edit_product', product_id=product.id) }}" class="btn btn-warning btn-sm">Editar</a>
                    <button class="btn btn-danger btn-sm" onclick="deleteProduct('{{ product.id }}')">Eliminar</button>
                    <button class="btn btn-primary btn-sm" onclick="addToCart('{{ product.id }}', '{{ product.nombre }}', {{ product.precio }})">Agregar</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-center">No hay productos registrados.</p>
    {% endif %}

    <!-- üõí Carrito -->
    <h3 class="mt-5">Productos en la Orden</h3>
    <table class="table table-bordered" id="orderTable" style="display: none;">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="orderList"></tbody>
    </table>
    <button class="btn btn-success mt-3" onclick="submitOrder()" id="buyButton" style="display: none;">Comprar</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");
    let cart = [];

    window.addToCart = function(id, name, price) {
        let existingProduct = cart.find(p => p.id === id);
        if (existingProduct) {
            existingProduct.quantity++;
        } else {
            cart.push({ id, name, price, quantity: 1 });
        }
        updateCart();
    };

    window.updateCart = function() {
        let orderList = document.getElementById("orderList");
        let orderTable = document.getElementById("orderTable");
        let buyButton = document.getElementById("buyButton");
        orderList.innerHTML = "";

        if (cart.length > 0) {
            orderTable.style.display = "table";
            buyButton.style.display = "block";
        } else {
            orderTable.style.display = "none";
            buyButton.style.display = "none";
        }

        cart.forEach((product, index) => {
            orderList.innerHTML += `
                <tr>
                    <td>${product.name}</td>
                    <td>
                        <input type="number" value="${product.quantity}" min="1"
                               class="form-control form-control-sm"
                               onchange="updateQuantity(${index}, this.value)">
                    </td>
                    <td>S/ ${(product.price * product.quantity).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">Eliminar</button>
                    </td>
                </tr>`;
        });
    };

    window.updateQuantity = function(index, value) {
        let newQuantity = parseInt(value);
        if (newQuantity > 0) {
            cart[index].quantity = newQuantity;
            updateCart();
        }
    };

    window.removeFromCart = function(index) {
        cart.splice(index, 1);
        updateCart();
    };

    window.submitOrder = function() {
        if (cart.length === 0) {
            alert("No hay productos en la orden.");
            return;
        }

        let orderData = {
            usuario_id: 26, // üîπ cambiar por el usuario autenticado
            products: cart.map(p => ({ producto_id: p.id, cantidad: p.quantity }))
        };

        fetch("/orders", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            credentials: "same-origin",
            body: JSON.stringify(orderData)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("Orden creada con √©xito.");
                cart = [];
                updateCart();
            } else {
                alert("Error al crear la orden: " + data.message);
            }
        })
        .catch(() => alert("Error inesperado al crear la orden."));
    };

    window.deleteProduct = function(productId) {
        if (!confirm("¬øSeguro que deseas eliminar este producto?")) return;

        fetch(`/admin/products/${productId}/delete`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            credentials: "same-origin"
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("Producto eliminado correctamente.");
                location.reload();
            } else {
                alert("Error al eliminar el producto: " + data.message);
            }
        })
        .catch(error => {
            console.error(error);
            alert("Error inesperado al eliminar el producto.");
        });
    };
});
</script>
{% endblock %}
